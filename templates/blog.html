{% extends 'base.html' %}
{% load static %}

{% block title %}Blog - {{ block.super }}{% endblock %}

{% block content %}
  <div id="blog-holder">
    <div class="text-container">
      <h1>Blog</h1>
    </div>
  
    <div class="text-container">
      <ul id="posts-list" class="posts">
        {% for post in posts %}
          <li>
            <div class="post-thumbnail">
              <img src="{% static 'images/blog/' %}{{ post.thumbnail }}" alt="{{ post.title }}" width="70px" height="70px" />
            </div>
            <div class="post-text">
              <a class="post-link" id="{{ post.pk }}" href="#">{{ post.title }}</a>
              <div class="post-date">{{ post.date_posted }}</div>
              <div class="post-description">{{ post.description }}</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <textarea id="copy-holder"></textarea>
{% endblock content %}

{% block extra_js %}
  <script>
      var blog_holder_original = $("#blog-holder").html();
      var copy_button_template = ""
  
      // links to blog posts
      $("#blog-holder").click(function(e) {
          if (e.target !== e.currentTarget && $(e.target).hasClass('post-link')) {
              loadBlogPost(e.target.id, blog_holder_original);
          }
  
          return false;
      });

      function loadBlogPost(post_id) {
          $.ajax({
              method: "GET",
              url: "{% url 'blog' %}" + post_id + '/',
              success: function(response) {
                  $("#blog-holder").html(response);

                  // attach listener for return button after post is rendered
                  $("#blog-return-link").click(function(e) {
                      $("#blog-holder").html(blog_holder_original);
                  });

                  // attach copy buttons to all code blocks
                  addCopyButtons();
              }
          })
      };

      // open post with query string
      var getQueryString = function(field, url) {
          var href = url ? url : window.location.href;
          var reg = new RegExp('[?&]' + field + '=([^&#/]*)', 'i');
          var string = reg.exec(href);
          return string ? string[1] : null;
      };

      function getCopyButtonTemplate() {
          var copy_button = $("#copy-button-template").clone();
          copy_button.removeAttr("id");
          copy_button.removeClass("hidden");
          copy_button.click(copyCodeBlockToClipboard)
          return copy_button;
      };

      function addCopyButtons() {
          $(".code-block").prepend(getCopyButtonTemplate());
      };

      var copyToClipboard = function(contents) {
          var copy_holder = document.getElementById("copy-holder");
          copy_holder.value = contents;
          copy_holder.select();
          var success = document.execCommand("copy");
          copy_holder.value = "";
      };

      var copyLinkToClipboard = function(element) {
          var contents = element.href;
          copyToClipboard(contents);

          var copied_message = $(element).children(".copied-message")[0];
          fadeInFadeOut(copied_message);
      }

      var fadeInFadeOut = function(element) {
        var _fadeOut = function() {
          $(element).animate(
            {opacity: 0.0},
            {duration: 500}
          )
        };

        $(element).animate(
          {opacity: 1.0},
          {duration: 500, done: function() {
            setTimeout(_fadeOut, 1000);
          }}
        );
      }

      var copyCodeBlockToClipboard = function() {
          var contents = "";
          $(this).siblings("div").each(function() {
              contents += this.innerText + "\n";
          });
          copyToClipboard(contents);
      }

      window.onload = function() {
          var post_id = getQueryString("post-id", window.location.href);
          if (post_id === null || post_id === undefined) {
              return;
          } else {
              loadBlogPost(post_id);
          }
      };
  </script>
{% endblock extra_js %}
